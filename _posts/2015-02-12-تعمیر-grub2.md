---
layout: post
title: تعمیر و بازیابی grub
permalink: /گنو-لینوکس/تعمیر-grub2
post_id: 470
author: milad
categories: 
- how to repair grub
- repair grub
- بازگردانی grub
- تعمیر grub
- تعمیر گراب
- راهنما نکات و ترفندها
- گنو/لینوکس
---

شاید تاکنون با مواردی همچون عدم نمایش grub یا تخریب شدن آن مواجه شده باشید، این مشکل ممکن است بنا به دلایل مختلفی همچون نصب سایر سیستم‌عامل‌ها پس از گنو/لینوکس رخ داده باشد.

برای رفع مشکل راه حل‌های متفاوتی وجود دارد، در این پست با استفاده از یک دیسک زنده گنو/لنوکس در Terminal با تغییر root یا به عبارتی `chroot`، بدون نیاز به بسته خاصی به برسی نحوه تعمیر و رفع مشکل grub خواهیم پرداخت.

ابتدا سیستم را با یک دیسک زنده گنو/لینوکس Boot کرده و ترمینال را باز نمایید.
برای انجام عملیات `chroot` لازم است پارتیشن `/` (root) که توزیع خود را بر  روی آن نصب کرده‌ایم بدانیم، برای نمایش یک لیست از پارتیشن‌های موجود از `fdisk` استفاده می‌کنیم:

{% highlight bash %}
sudo fdisk -l
{% endhighlight %}

پس از وارد کردن دستور فوق در صورتی که رمز عبور سوال شد، آن را وارد نمایید، عموما در دیسک‌های زنده رمزعبور خواسته نمی‌شود و در صورت نیاز در هنگام لاگین به سیستم یا باز کردن ترمینال رمز عبور دیسک زنده به شما نمایش داده خواهد شد.

در خروجی دستور فوق، پارتیشنی که به عنوان `/` (root) درنظر گرفته بودید را شناسایی نمایید، این نام باید مشابه `dev/sdXY/` باشد.

{% highlight bash %}
X: یک حرف مانند a یا b و...

Y: یک عدد
{% endhighlight %}
برای مثال پارتیشن روت ما `dev/sda5/` است.

حال پارتیشن `/` (root) را `mount` میکنیم:
{% highlight bash %}
sudo mount /dev/sda5 /mnt
{% endhighlight %}

اگر در هنگام نصب توزیع خود، پارتیشن مجزایی برای `boot/` در نظر گرفته بوده‌اید با دستور زیر `boot/` را هم `mount` نمایید:

{% highlight bash %}
sudo mount /dev/sda6 /mnt/boot
{% endhighlight %}
در دستور فوق فرض بر این است که `dev/sda6/` پارتیشن boot می‌باشد.

حال با ls یک لیست از شاخه `mnt` بگیرید تا اطمینان پیدا کنید که عملیات `mount` صحیح اجرا شده و آماده سایر مراحل هستیم:

{% highlight bash %}
ls /mnt
{% endhighlight %}
خروجی باید مشابه زیر باشد:

{% highlight bash %}
bin   etc   initrd.img.old   media   proc   sbin   tmp   vmlinuz
boot home lib mnt   root srv   usr   vmlinuz.old
dev   initrd.img   lost+found   opt   run   sys   var
{% endhighlight %}
همینکار را برای شاخه `boot/` تکرار نمایید:

{% highlight bash %}
ls /boot
{% endhighlight %}

خروجی مشابه زیر دریافت خواهید کرد:

{% highlight bash %}
abi-3.13.0-44-generic
abi-3.13.0-45-generic
vmlinuz-3.13.0-45-generic
...
{% endhighlight %}
حال باید شاخه های زیر را برروی شاخه مشابه در mnt به صورت bind‌ سوار نماییم (`mount` کنیم):

{% highlight bash %}
/dev
/dev/pts
/proc
/sys

{% endhighlight %}

انجام عملیات Mount به همراه پارامتر bind باعث می‌شود محتویات شاخه های فوق در هر دو محل به صورت یکسان قابل دسترس باشند. نحوه mount کردن به صورت زیر خواهد بود:

{% highlight bash %}
sudo mount --bind foo bar
{% endhighlight %}
یا به صورت زیر:

{% highlight bash %}
sudo mount -B foo bar
{% endhighlight %}

در نتیجه لازم است شاخه های مذکور را به صورت ذکر شده `mount` نماییم، برای مثال نحوه مانت شاخه `dev/` به صورت زیر خواهد بود:

{% highlight bash %}
sudo mount -B /dev /mnt/dev
{% endhighlight %}

برای راحتی و سرعت بخشیدن به کار میتوان از یک حلقه for استفاده کرد. کد زیر هر ۴ شاخه مذکور را در محل صحیح mount خواهد کرد، این دستور را در یک خط وارد و اجرا نمایید:

{% highlight bash %}
for i in /dev /dev/pts /proc /sys; do sudo mount -B $i /mnt$i; done
{% endhighlight %}
حال با دستور زیر شاخه root را تغییر میدهم (`chroot`).

{% highlight bash %}
sudo chroot /mnt
{% endhighlight %}
دستور زیر فایل پیکربندی grub را برای سیستم ایجاد خواهد کرد:

{% highlight bash %}
sudo update-grub
{% endhighlight %}
حال برای نصب مجدد grub در MBR‌ باید بدانیم سیستم از کدام Disk برای بوت شدن استفاده میکند. برای این منظور میتوانید مجددا از `fdisk -l‌` استفاده نمایید.

آدرس دیسک باید به صورت زیر باشد:

{% highlight bash %}
/dev/sdX
{% endhighlight %}
که x یک حرف مانند a یا b و یا ... می‌باشد، یعنی آدرسی مشابه زیر:

{% highlight bash %}
/dev/sda
{% endhighlight %}
حال با دستور زیر گراب را بر MBR دیسک مدنظر نصب می‌نماییم:

{% highlight bash %}
sudo grub-install /dev/sda
{% endhighlight %}
سپس با دستور `exit` یا فشردن `ctrl+d` از chroot خارج شوید.

حال نوبت آن است که پارتیشن و شاخه‌های `mount` شده را `umount` نماییم، به این منظور دستور زیر را در یک خط وارد و اجرا نمایید:

{% highlight bash %}
for i in /dev/pts /dev /proc /sys; do sudo umount /mnt$i; done
{% endhighlight %}

در صورتی که پارتیشن `boot/` را مجزا ایجاد و `mount` کرده بودید آن را `umount` نمایید، سپس `mnt/` را `umount` کنید:
{% highlight bash %}
sudo umount /mnt
{% endhighlight %}
نهایتا سیستم را `reboot` نمایید:

{% highlight bash %}
sudo shutdown -r now
{% endhighlight %}